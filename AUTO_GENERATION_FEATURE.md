# Auto-Generated DG Operation Records Feature

## Overview

This feature automatically creates placeholder DG operation records when the server starts for the first time each day, and these records are automatically deleted when a user creates their first real record for that date.

## Changes Made

### 1. Database Schema (`prisma/schema.prisma`)

Added a new field to track auto-generated records:

```prisma
isAutoGenerated Boolean  @default(false)
```

This field allows us to distinguish between auto-generated placeholder records and real user-created records.

### 2. Server Instrumentation (`instrumentation.ts`)

Created a new file that runs once when the Next.js server starts:

**Key Features:**

- Runs automatically on server startup (Node.js runtime only)
- Checks if any records exist for today's date
- If no records exist, creates 3 auto-generated records (one for each shift: M/s, G/s, E/s)
- Auto-generated records have:
  - Only `date` and `shift` fields populated
  - All other fields are `null` (blank)
  - `isAutoGenerated` set to `true`
  - Uses a system user (first TA user, or first available user)

**Console Output:**

- `No records found for today. Creating auto-generated entries...` - When creating records
- `Auto-generated records created successfully for all shifts.` - When creation is successful
- `Records already exist for today. Skipping auto-generation.` - When records already exist

### 3. API Route Modification (`app/api/dg-operations/route.ts`)

Enhanced the POST endpoint to automatically delete auto-generated records:

**Behavior:**

- When a user creates their first real record for a date
- The system finds all auto-generated records for that same date
- Deletes all auto-generated records for that date
- Then creates the user's real record with `isAutoGenerated: false`

This ensures that placeholder records don't clutter the system once actual data entry begins.

## How It Works

### Scenario 1: First Server Start of the Day (No Records)

1. Server starts
2. `instrumentation.ts` checks database for today's date
3. No records found
4. Creates 3 auto-generated records:
   - Date: Today (00:00:00)
   - Shift: M/s, G/s, E/s (one for each)
   - All other fields: `null`
   - `isAutoGenerated`: `true`

### Scenario 2: User Creates First Record

1. User submits a DG operation form
2. POST endpoint checks for auto-generated records for that date
3. Finds and deletes all auto-generated records for that date
4. Creates the user's real record with all provided data
5. Logs: `Deleted X auto-generated record(s) for [date]`

### Scenario 3: Server Restart (Records Exist)

1. Server starts
2. `instrumentation.ts` checks database for today's date
3. Records exist (either auto-generated or real)
4. Skips creation
5. Logs: `Records already exist for today. Skipping auto-generation.`

## Database Migration

Since you're using MongoDB, the schema was updated using:

```bash
npx prisma db push
```

This added the `isAutoGenerated` field to existing records with a default value of `false`.

## Testing

To test the feature:

1. **Test Auto-Generation:**

   - Ensure no records exist for today in the database
   - Start the server: `npm run dev`
   - Check console logs for "Auto-generated records created successfully"
   - Query the database to see 3 placeholder records

2. **Test Auto-Deletion:**

   - With auto-generated records present
   - Create a new DG operation record via the UI or API
   - Auto-generated records should be deleted
   - Only the new real record should remain

3. **Test Skip Logic:**
   - With real records already present for today
   - Restart the server
   - Should see "Records already exist for today. Skipping auto-generation."

## Notes

- Auto-generation only happens when the server starts
- It's based on calendar days (midnight to midnight)
- Multiple server restarts on the same day won't create duplicates
- All 3 shifts are created at once (M/s, G/s, E/s)
- The feature requires at least one user in the database to function
- Auto-generated records are marked and can be easily identified in the database

## Troubleshooting

If auto-generation doesn't work:

1. Check if the database connection is working
2. Verify at least one user exists in the system
3. Check server console logs for error messages
4. Ensure the instrumentation file is being loaded by Next.js
